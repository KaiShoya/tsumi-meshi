# Copilot 向けコーディングルール（tsumi-meshi）

目的: Copilot / 自動エディタ支援が生成する変更で lint/typecheck/tests が連鎖的に壊れるのを防ぐため、守るべきスタイルと実務ルールを明確化します。

1) 全体方針
- 既存の ESLint / TypeScript 設定を最優先で守る。自動生成コードはまず `pnpm lint --fix` を通すこと。
- 変更が API 影響を与える場合は必ず `.agent/specs` または `.agent/docs` を同一 PR で更新する。
- 重大なルール緩和が必要なら PR で提案して合意を得る（勝手にルールをオフにしない）。

2) TypeScript のルール
- `any` を避ける。どうしても必要な場合は明確な `// NOTE:` コメント付きで使い、該当箇所を最小化する。
- 型はサーバー側（Workers）の仕様や共有型定義を参照してください。外部ランタイム形状は `as` キャストで扱い、アクセスは型ガードで保護する。
  例: `const res = await $fetch('/api/v1/x') as { foo?: Foo }`
- `import type { Foo } from '...'` を使って不要な実行時インポートを避ける。

3) Vue テンプレート（ESLint vue ルール準拠）
- 属性は長い場合は1行に複数置かない（`max-attributes-per-line`）。複数属性は改行して 1 属性ずつ書く。
- `singleline-html-element-content-newline` を尊重する（テキストを含む要素は改行して書く）。
- HTML void 要素（`img`, `input` 等）はプロジェクトの ESLint 設定に従う（現行設定では `img` を自己終了しない形式で使用する）。
- コンポーネントのタグは可読性のため複数属性で改行する。

4) i18n
- 文字列は `t('namespace.key')` を使う。直接の日本語/英語埋め込みは原則不可。例外はテスト用のモックのみ。

5) 依存と動的 import
- オプション依存（例: `@aws-sdk/*`）は動的 import で扱い、未導入時は有益なエラーメッセージを返す。

6) テストとチェック手順（PR 作成前必須）
```
pnpm lint --fix
pnpm typecheck
pnpm test -- --run
```
- これらがすべて通ったらコミット候補。PR を作る前にローカルで再度実行して CI と同じ状態を確認する。

7) コミット／PR 作法
- 変更点は小さく分けてコミットする（実装、テスト、ドキュメントを分けない）。
- PR には必ず関連する `.agent/specs` と `CHANGELOG.md`（リリース用）を更新する説明を追加する。
- リモート Push は必ずユーザー承認を得る（自動で push しない）。

8) 例外・実務注意
- テンプレート整形（Vue の改行/属性移動）で多数の ESLint 指摘が出た場合は、まず `pnpm lint --fix` を実行し、それでも残るものを手動で直す。
- サーバーのランタイム設定は `useRuntimeConfig()` を使う。ブラウザで `process.env` を直接参照しない。

9) 変更履歴を残す
- このファイルは Copilot 向けルールの単一ソース。ルールを更新する場合は理由と日付を必ず追記する。

---
短く簡潔に。必要ならこのルールを `.eslintrc` に反映する提案を作成します。
